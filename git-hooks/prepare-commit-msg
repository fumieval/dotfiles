#!/usr/bin/env bash

# Abort if a preivious commit message already exists
if (( $(grep -v "^#" "$1" | wc -l) > 1 )); then
  exit 0
fi

original=$(grep "^#" "$1")

pattern=.
if [ -e .gitattributes ]; then
  pattern=$(awk 'NF==0 {next} /^#.*/ {next} /linguist-generated=true/ {print ":^" $1}' < .gitattributes)
fi

# https://github.com/kardolus/chatgpt-cli
chatgpt 'Generate a terse but descriptive commit message from the following diff' \
  "$(git diff --cached -- "$pattern" | head -n100)" > $1

echo "$original" >> $1
